# АРХИТЕКТУРА ПРОЕКТА AVIATICKETS MARKET

## 📋 ОБЗОР ПРОЕКТА

**Aviatickets Market** - это полнофункциональная система для поиска и бронирования авиабилетов, состоящая из мобильного приложения на React Native и backend API на NestJS с интеграцией к внешнему провайдеру авиабилетов Onelya.

### 🎯 Основные возможности:
- Поиск авиарейсов по различным критериям
- Бронирование билетов с выбором тарифов
- Система авторизации (email/password + OAuth Google/Apple)
- Управление профилем пользователя
- Чат поддержки
- FAQ система
- Генерация PDF билетов

---

## 🏗️ АРХИТЕКТУРА СИСТЕМЫ

```
┌─────────────────────────────────────────────────────────────┐
│                    МОБИЛЬНОЕ ПРИЛОЖЕНИЕ                      │
│                    (React Native + Expo)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Поиск рейсов  │  │   Бронирование  │  │   Профиль    │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                           HTTP/REST API
                                │
┌─────────────────────────────────────────────────────────────┐
│                      BACKEND API                            │
│                    (NestJS + TypeScript)                    │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Auth Module   │  │  Flights Module │  │ Booking Mod. │ │
│  │   Users Module  │  │  Onelya Module  │  │ Support Mod. │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                        HTTP API Integration
                                │
┌─────────────────────────────────────────────────────────────┐
│                    ВНЕШНИЕ СЕРВИСЫ                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │   Onelya API    │  │   MongoDB       │  │ Google OAuth │ │
│  │ (Авиабилеты)    │  │   (База данных) │  │   (Auth)     │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 📱 МОБИЛЬНОЕ ПРИЛОЖЕНИЕ (React Native)

### 📂 Структура проекта:
```
aviatickets-demo/
├── components/          # Переиспользуемые компоненты
│   ├── FlightCard.js   # Карточка рейса
│   ├── FlightDetails.js # Детали рейса
│   ├── Input.js        # Поле ввода
│   ├── LoadingOverlay.js # Индикатор загрузки
│   └── PrimaryButton.js # Основная кнопка
├── constants/          # Константы и конфигурация
│   ├── airports.js     # Список аэропортов
│   └── api.js         # Конфигурация API
├── contexts/          # React Context для состояния
│   └── AuthContext.js # Контекст авторизации
├── data/             # Статические данные
│   └── airports.js   # База аэропортов
├── hooks/            # Кастомные хуки
│   └── useFonts.js   # Загрузка шрифтов
├── lib/              # Утилиты и API клиент
│   ├── api.js        # HTTP клиент
│   └── mockOrders.js # Моковые данные
├── navigation/       # Навигация приложения
│   ├── BottomTabs.js # Нижние вкладки
│   └── RootNavigation.js # Корневая навигация
├── screens/          # Экраны приложения
│   ├── HomeScreen.js      # Главный экран поиска
│   ├── ResultsScreen.js   # Результаты поиска
│   ├── BookingScreen.js   # Бронирование
│   ├── LoginScreen.js     # Авторизация
│   ├── ProfileScreen.js   # Профиль
│   └── [другие экраны]
├── services/         # Сервисы
│   └── authProviders.js # OAuth провайдеры
├── utils/           # Утилиты
│   └── clearLocalBookings.js
├── App.js          # Корневой компонент
└── package.json    # Зависимости
```

### 🔧 Технологический стек:
- **React Native 0.81.5** - основной фреймворк
- **Expo SDK 54** - инструменты разработки
- **React Navigation 7** - навигация между экранами
- **AsyncStorage** - локальное хранение данных
- **Expo SecureStore** - безопасное хранение токенов
- **React Native SVG** - векторная графика
- **Expo Image Picker** - работа с изображениями

### 🎨 Ключевые особенности UI/UX:
- **Современный Material Design** с градиентами
- **Адаптивная верстка** под разные размеры экранов
- **Анимации и переходы** для плавного UX
- **Темная/светлая тема** (частично реализовано)
- **Оффлайн поддержка** для базовых функций

### 📱 Основные экраны:

#### 🏠 HomeScreen (Главный экран)
- Форма поиска рейсов с полями:
  - Откуда/Куда (выбор городов)
  - Дата вылета/возврата
  - Количество пассажиров
  - Класс обслуживания
  - Тип тарифа
- Переключатель "В одну сторону"/"Туда-обратно"
- Кнопка поиска с валидацией

#### 🔍 ResultsScreen (Результаты поиска)
- Список найденных рейсов
- Фильтры по цене, времени, авиакомпании
- Сортировка по различным критериям
- Детальная информация о каждом рейсе

#### ✈️ BookingScreen (Бронирование)
- Форма данных пассажиров
- Выбор дополнительных услуг
- Расчет итоговой стоимости
- Интеграция с платежной системой

#### 👤 ProfileScreen (Профиль)
- Информация о пользователе
- История бронирований
- Настройки уведомлений
- Выход из аккаунта

---

## 🖥️ BACKEND API (NestJS)

### 📂 Структура проекта:
```
tickets-backend/
├── src/
│   ├── auth/                    # Модуль авторизации
│   │   ├── dto/                # DTO для валидации
│   │   │   ├── login.dto.ts
│   │   │   ├── register.dto.ts
│   │   │   └── oauth.dto.ts
│   │   ├── guards/             # Защитники маршрутов
│   │   │   └── jwt-auth.guard.ts
│   │   ├── auth.controller.ts  # Контроллер авторизации
│   │   ├── auth.service.ts     # Сервис авторизации
│   │   ├── auth.module.ts      # Модуль авторизации
│   │   ├── oauth.controller.ts # OAuth контроллер
│   │   └── oauth.service.ts    # OAuth сервис
│   ├── booking/                # Модуль бронирования
│   │   ├── booking.controller.ts
│   │   ├── booking.service.ts
│   │   └── booking.module.ts
│   ├── flights/                # Модуль поиска рейсов
│   │   ├── flights.controller.ts
│   │   ├── flights.service.ts
│   │   ├── flights.module.ts
│   │   ├── flight-offer.store.ts    # In-memory хранилище
│   │   ├── flight-offer.entity.ts   # Сущность предложения
│   │   └── direct-search.controller.ts
│   ├── onelya/                 # Интеграция с Onelya API
│   │   ├── dto/               # DTO для Onelya API
│   │   │   ├── avia-search.dto.ts
│   │   │   └── order-reservation.dto.ts
│   │   ├── interceptors/      # Перехватчики запросов
│   │   │   └── onelya-logging.interceptor.ts
│   │   ├── utils/            # Утилиты
│   │   │   ├── provider-raw.builder.ts
│   │   │   └── select-brand-fare.ts
│   │   ├── onelya.controller.ts
│   │   ├── onelya.service.ts
│   │   ├── onelya.module.ts
│   │   └── onelya.health.controller.ts
│   ├── providers/             # Абстракция провайдеров
│   │   ├── onelya.provider.ts
│   │   └── provider.interface.ts
│   ├── schemas/              # MongoDB схемы
│   │   ├── user.schema.ts    # Схема пользователя
│   │   ├── booking.schema.ts # Схема бронирования
│   │   ├── faq.schema.ts     # Схема FAQ
│   │   └── support-message.schema.ts
│   ├── support/              # Модуль поддержки
│   │   ├── support.controller.ts
│   │   ├── support.service.ts
│   │   └── support.module.ts
│   ├── users/               # Модуль пользователей
│   │   ├── dto/
│   │   │   └── update-user.dto.ts
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.module.ts
│   ├── faq/                # Модуль FAQ
│   │   ├── faq.controller.ts
│   │   ├── faq.service.ts
│   │   ├── faq.module.ts
│   │   ├── faq-seed.service.ts
│   │   └── seed-faq.ts
│   ├── app.module.ts       # Корневой модуль
│   ├── app.controller.ts   # Корневой контроллер
│   ├── app.service.ts      # Корневой сервис
│   └── main.ts            # Точка входа
├── test/                  # E2E тесты
├── docker-compose.yml     # Docker конфигурация
├── Dockerfile            # Docker образ
├── .env                 # Переменные окружения
└── package.json         # Зависимости
```

### 🔧 Технологический стек:
- **NestJS 10** - основной фреймворк
- **TypeScript 5.9** - типизированный JavaScript
- **MongoDB + Mongoose** - база данных
- **JWT + Passport** - авторизация
- **Swagger/OpenAPI** - документация API
- **Axios** - HTTP клиент для внешних API
- **bcrypt** - хеширование паролей
- **class-validator** - валидация DTO

### 🏛️ Архитектурные принципы:

#### 📦 Модульная архитектура
Каждый модуль инкапсулирует свою бизнес-логику:
- **AuthModule** - авторизация и аутентификация
- **FlightsModule** - поиск рейсов
- **BookingModule** - бронирование билетов
- **OnelyaModule** - интеграция с внешним API
- **UsersModule** - управление пользователями
- **SupportModule** - система поддержки
- **FaqModule** - база знаний

#### 🔒 Система безопасности
- **JWT токены** с истечением через 7 дней
- **bcrypt хеширование** паролей (10 раундов)
- **JwtAuthGuard** для защиты приватных маршрутов
- **OAuth интеграция** с Google и Apple
- **Валидация входных данных** через class-validator
- **CORS настройки** для безопасных запросов

#### 📊 База данных (MongoDB)
```javascript
// Схема пользователя
User {
  fullName: string
  email: string (unique, indexed)
  phone: string
  passwordHash: string (select: false)
  passport: {
    passportNumber?: string
    country?: string
    expiryDate?: Date
  }
  notifications: {
    emailNotifications: boolean
    pushNotifications: boolean
  }
  consents: {
    termsAccepted: boolean
    termsAcceptedAt?: Date
    notificationsAccepted: boolean
    notificationsAcceptedAt?: Date
  }
  avatarUrl?: string
  avatar?: Buffer (select: false)
  googleId?: string (indexed)
  appleId?: string (indexed)
  oauthProvider?: 'google' | 'apple'
  isActive: boolean
  createdAt: Date
  updatedAt: Date
}

// Схема бронирования
Booking {
  user: ObjectId (ref: User)
  from: string
  to: string
  departureDate: Date
  returnDate?: Date
  isRoundTrip: boolean
  flightNumber?: string
  passengers: Array<{
    fullName: string
    passportNumber?: string
    dateOfBirth?: Date
  }>
  payment: {
    paymentStatus: 'pending' | 'virtual' | 'paid' | 'canceled' | 'refunded'
    amount: number
    currency: string
    paymentMethod?: string
    cardLast4?: string
    cardBrand?: string
  }
  bookingStatus: 'created' | 'awaiting_payment' | 'paid' | 'ticketed' | 'canceled' | 'voided'
  provider?: string
  providerBookingId?: string
  rawProviderData?: any
  createdAt: Date
  updatedAt: Date
}
```

---

## 🔌 ИНТЕГРАЦИЯ С ONELYA API

### 🎯 Основные эндпоинты Onelya:

#### 🔍 Поиск рейсов
- **RoutePricing** - основной поиск маршрутов
- **BrandFarePricing** - получение брендированных тарифов
- **DatePricing** - поиск по датам
- **FareInfoByRoute** - детальная информация о тарифах

#### 📋 Бронирование
- **Reservation/Create** - создание бронирования
- **Reservation/Recalc** - пересчет стоимости
- **Reservation/Confirm** - подтверждение бронирования
- **Reservation/Blank** - получение PDF билета
- **Reservation/Void** - отмена бронирования

### 🔄 Процесс поиска и бронирования:

```mermaid
sequenceDiagram
    participant App as Mobile App
    participant API as Backend API
    participant Onelya as Onelya API
    participant Store as Flight Store
    participant DB as MongoDB

    App->>API: POST /flights/search
    API->>Onelya: RoutePricing request
    Onelya-->>API: Routes response
    
    loop For each route
        API->>Onelya: BrandFarePricing request
        Onelya-->>API: BrandFares response
        API->>Store: Save flight offer
    end
    
    API-->>App: Flight cards with offerIds
    
    App->>API: POST /booking/create
    API->>Store: Get flight offer by offerId
    API->>Onelya: Reservation/Create
    Onelya-->>API: OrderId response
    API->>DB: Save booking
    API-->>App: Booking confirmation
```

### 🏪 Flight Offer Store
In-memory хранилище для временного хранения предложений рейсов:
```typescript
interface FlightOffer {
  offerId: string;           // UUID для фронтенда
  providerRoute: any;        // Исходный маршрут от RoutePricing
  providerRaw: any;          // Данные для бронирования от BrandFarePricing
  brandFares?: any[] | null; // Брендированные тарифы
}
```

---

## 🌐 API ЭНДПОИНТЫ

### 🔐 Авторизация (`/auth`)
```
POST /auth/register     - Регистрация пользователя
POST /auth/login        - Вход в систему
POST /auth/google       - OAuth через Google
POST /auth/apple        - OAuth через Apple
```

### ✈️ Поиск рейсов (`/flights`)
```
POST /flights/search    - Поиск рейсов
POST /flights/fare-info - Детальная информация о тарифе
```

### 📋 Бронирование (`/booking`)
```
POST /booking/create    - Создание бронирования
GET  /booking/my        - Мои бронирования
GET  /booking/:id       - Детали бронирования
POST /booking/:id/pdf   - Получение PDF билета
POST /booking/:id/cancel - Отмена бронирования
```

### 👤 Пользователи (`/users`)
```
GET  /users/profile     - Профиль пользователя
PUT  /users/profile     - Обновление профиля
POST /users/avatar      - Загрузка аватара
```

### 💬 Поддержка (`/support`)
```
GET  /support/messages  - Сообщения поддержки
POST /support/messages  - Отправка сообщения
PUT  /support/messages/:id/read - Отметить как прочитанное
```

### ❓ FAQ (`/faq`)
```
GET  /faq              - Список FAQ
GET  /faq/categories   - Категории FAQ
```

---

## 🚀 РАЗВЕРТЫВАНИЕ И ИНФРАСТРУКТУРА

### 🐳 Docker конфигурация
```yaml
# docker-compose.yml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - MONGO_URI=mongodb://mongo:27017/tickets
      - JWT_SECRET=changeme
    depends_on:
      - mongo
  mongo:
    image: mongo:6
    restart: always
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
```

### 🌍 Переменные окружения
```bash
# Backend (.env)
PORT=3000
NODE_ENV=production

# Onelya API
ONELYA_BASE_URL=https://api-test.onelya.ru
ONELYA_LOGIN=trevel_test
ONELYA_PASSWORD=5mPaN5KyB!27LN!
ONELYA_POS=trevel_test

# Database
MONGO_URI=mongodb+srv://...

# JWT
JWT_SECRET=a7f3e9c2b8d4f1a6e5c9b3d7f2a8e4c1b9d5f3a7e2c8b4d1f6a9e3c7b2d8f4a1

# OAuth
GOOGLE_CLIENT_ID=656373020226-...
GOOGLE_CLIENT_SECRET=GOCSPX-...
```

### 📱 Мобильное приложение
```javascript
// constants/api.js
export const API_BASE = process.env.EXPO_PUBLIC_API_BASE || 
                        'http://193.233.103.8:3000/api';
```

---

## 🔄 ЖИЗНЕННЫЙ ЦИКЛ БРОНИРОВАНИЯ

### 1️⃣ Поиск рейсов
```
Пользователь → Форма поиска → Backend API → Onelya RoutePricing → 
→ Onelya BrandFarePricing → Flight Store → Результаты поиска
```

### 2️⃣ Выбор рейса
```
Клик на рейс → Детали рейса → Выбор тарифа → 
→ Переход к бронированию
```

### 3️⃣ Бронирование
```
Форма пассажиров → Валидация данных → Backend API → 
→ Onelya Reservation/Create → Сохранение в MongoDB → 
→ Подтверждение бронирования
```

### 4️⃣ Оплата (будущая функциональность)
```
Выбор способа оплаты → Платежный шлюз → 
→ Onelya Reservation/Confirm → Выдача билета
```

---

## 🛡️ БЕЗОПАСНОСТЬ И ПРОИЗВОДИТЕЛЬНОСТЬ

### 🔒 Меры безопасности:
- **Хеширование паролей** с bcrypt
- **JWT токены** с коротким временем жизни
- **Валидация всех входных данных**
- **CORS политики**
- **Rate limiting** (планируется)
- **Логирование всех операций**

### ⚡ Оптимизация производительности:
- **In-memory кеширование** предложений рейсов
- **Пагинация** результатов поиска
- **Lazy loading** в мобильном приложении
- **Сжатие HTTP ответов**
- **Индексы MongoDB** для быстрых запросов
- **Connection pooling** для базы данных

### 📊 Мониторинг:
- **Логирование** всех API запросов
- **Health checks** для внешних сервисов
- **Метрики производительности**
- **Error tracking** и уведомления

---

## 🔮 ПЛАНЫ РАЗВИТИЯ

### 📈 Краткосрочные цели:
- ✅ Интеграция с реальными платежными системами
- ✅ Push уведомления
- ✅ Офлайн режим для базовых функций
- ✅ Расширенные фильтры поиска
- ✅ Система лояльности

### 🚀 Долгосрочные цели:
- 🔄 Интеграция с другими провайдерами авиабилетов
- 🏨 Добавление бронирования отелей
- 🚗 Аренда автомобилей
- 🤖 AI-помощник для планирования путешествий
- 📱 Веб-версия приложения

---

## 📚 ДОКУМЕНТАЦИЯ И РЕСУРСЫ

### 📖 API Документация:
- **Swagger UI**: `http://localhost:3000/api`
- **Onelya API**: Документация в PDF файле проекта

### 🛠️ Инструменты разработки:
- **Backend**: NestJS CLI, TypeScript, MongoDB Compass
- **Mobile**: Expo CLI, React Native Debugger
- **Testing**: Jest, Supertest
- **DevOps**: Docker, PM2

### 📋 Команды для запуска:

#### Backend:
```bash
npm install
npm run start:dev    # Разработка
npm run build        # Сборка
npm run start:prod   # Продакшн
docker-compose up    # Docker
```

#### Mobile:
```bash
npm install
expo start           # Разработка
expo build:android   # Сборка Android
expo build:ios       # Сборка iOS
```

---

## 🎯 ЗАКЛЮЧЕНИЕ

Проект **Aviatickets Market** представляет собой современную, масштабируемую систему для поиска и бронирования авиабилетов. Архитектура построена на принципах:

- **Модульности** - каждый компонент имеет четкую ответственность
- **Масштабируемости** - легко добавлять новые функции и провайдеров
- **Безопасности** - защита данных пользователей на всех уровнях
- **Производительности** - оптимизация для быстрой работы
- **Удобства использования** - интуитивный интерфейс

Система готова к продакшн развертыванию и дальнейшему развитию функциональности.